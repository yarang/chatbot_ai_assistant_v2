---
globs: models/*.py,repository/*.py
description: ëª¨ë¸ ë° Repository íŒ¨í„´ ê°€ì´ë“œ
---

# ğŸ§‘ ëª¨ë¸ ë° Repository íŒ¨í„´ ê°€ì´ë“œ

## ëª¨ë¸ êµ¬ì¡° (`models/`)

### User ëª¨ë¸ ì˜ˆì‹œ (`models/user_model.py`)

```python
import uuid
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import String, TIMESTAMP, func
from core.database import Base

class User(Base):
    __tablename__ = "users"

    uuid: Mapped[str] = mapped_column(String, primary_key=True, default=lambda: str(uuid.uuid4()))
    telegram_id: Mapped[int] = mapped_column(unique=True, nullable=False)
    username: Mapped[str] = mapped_column(String, nullable=True)
    first_name: Mapped[str] = mapped_column(String, nullable=True)
    created_at: Mapped[str] = mapped_column(TIMESTAMP, server_default=func.now())
```

## Repository íŒ¨í„´ (`repository/`)

### Repository ê¸°ë³¸ êµ¬ì¡°

```python
from models.conversation_model import Conversation

class ConversationRepository:
    async def create(self, session, user_uuid, question, answer, in_tokens, out_tokens):
        conv = Conversation(
            user_uuid=user_uuid,
            question=question,
            answer=answer,
            token_usage_input=in_tokens,
            token_usage_output=out_tokens
        )
        session.add(conv)
        await session.commit()
        await session.refresh(conv)
        return conv
```

## ëª¨ë¸ ë° Repository ì›ì¹™

### ëª¨ë¸ ì„¤ê³„ ì›ì¹™

- **SQLAlchemy 2.0**: `Mapped` íƒ€ì… íŒíŠ¸ ì‚¬ìš©
- **UUID**: Primary keyë¡œ UUID ì‚¬ìš©
- **íƒ€ì„ìŠ¤íƒ¬í”„**: `server_default=func.now()` ì‚¬ìš©
- **ë‹¨ì¼ ì±…ì„**: ê° ëª¨ë¸ì€ í•˜ë‚˜ì˜ ì—”í‹°í‹°ë§Œ ë‹´ë‹¹

### Repository íŒ¨í„´ ì›ì¹™

- **ë‹¨ì¼ ëª¨ë¸**: RepositoryëŠ” ë‹¨ì¼ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ì—ë§Œ ì ìš©
- **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬**: RepositoryëŠ” ë°ì´í„° ì ‘ê·¼ë§Œ ë‹´ë‹¹
- **Async íŒ¨í„´**: ëª¨ë“  ë©”ì„œë“œëŠ” async/await ì‚¬ìš©
- **Session ê´€ë¦¬**: ì™¸ë¶€ì—ì„œ sessionì„ ì£¼ì…ë°›ì•„ ì‚¬ìš©

### Repository ë©”ì„œë“œ ëª…ëª… ê·œì¹™

- `create()`: ìƒˆ ì—”í‹°í‹° ìƒì„±
- `get_by_id()`: IDë¡œ ì¡°íšŒ
- `get_or_create()`: ì¡°íšŒ í›„ ì—†ìœ¼ë©´ ìƒì„±
- `update()`: ì—”í‹°í‹° ì—…ë°ì´íŠ¸
- `delete()`: ì—”í‹°í‹° ì‚­ì œ
- `list_by_*()`: ì¡°ê±´ë³„ ëª©ë¡ ì¡°íšŒ