---
globs: api/*.py,main.py
description: API Router ë° FastAPI êµ¬ì¡° ê°€ì´ë“œ
---

# ğŸ“¡ API Router ë° FastAPI êµ¬ì¡° ê°€ì´ë“œ

## Router êµ¬ì¡° (`api/`)

### Telegram Router ì˜ˆì‹œ (`api/telegram_router.py`)

```python
from fastapi import APIRouter, Request, Depends
from core.database import SessionLocal
from repository.user_repository import UserRepository
from repository.conversation_repository import ConversationRepository
from services.conversation_service import ConversationService
from services.gemini_service import GeminiService
from core.exceptions import AppException

router = APIRouter()

@router.post("/telegram/webhook")
async def telegram_webhook(request: Request):
    data = await request.json()
    message = data.get("message", {})
    text = message.get("text", "")
    user_info = message.get("from", {})

    if not user_info:
        raise AppException("Invalid Telegram data", 400)

    async with SessionLocal() as session:
        user_repo = UserRepository()
        conv_repo = ConversationRepository()
        gemini = GeminiService()
        conv_service = ConversationService(conv_repo, gemini)

        user = await user_repo.get_or_create(
            session,
            telegram_id=user_info["id"],
            username=user_info.get("username"),
            first_name=user_info.get("first_name")
        )

        if "@myassistant" in text:
            prompt = text.replace("@myassistant", "").strip()
            conv = await conv_service.handle_question(session, user.uuid, prompt)
            return {"text": conv.answer}

    return {"status": "ignored"}
```

## Main Application (`main.py`)

```python
from fastapi import FastAPI
from api import telegram_router
from core.database import Base, engine
from core.middleware import LoggingMiddleware
from core.exceptions import AppException, app_exception_handler, generic_exception_handler

app = FastAPI(title="Telegram Gemini Q&A")

# âœ… Middleware ë“±ë¡
app.add_middleware(LoggingMiddleware)

# âœ… Exception í•¸ë“¤ëŸ¬ ë“±ë¡
app.add_exception_handler(AppException, app_exception_handler)
app.add_exception_handler(Exception, generic_exception_handler)

# âœ… DB ì´ˆê¸°í™”
@app.on_event("startup")
async def startup():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

# âœ… Router ì—°ê²°
app.include_router(telegram_router.router)
```

## API ì„¤ê³„ ì›ì¹™

### Router êµ¬ì¡°

- **ê¸°ëŠ¥ë³„ ë¶„ë¦¬**: ê° RouterëŠ” í•˜ë‚˜ì˜ ê¸°ëŠ¥ ì˜ì—­ë§Œ ë‹´ë‹¹
- **ì˜ì¡´ì„± ì£¼ì…**: Repositoryì™€ Serviceë¥¼ Routerì—ì„œ ì¡°í•©
- **ì˜ˆì™¸ ì²˜ë¦¬**: AppExceptionì„ í†µí•œ í‘œì¤€í™”ëœ ì—ëŸ¬ ì‘ë‹µ

### ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

- **RESTful**: ê°€ëŠ¥í•œ ê²½ìš° REST ì›ì¹™ ì¤€ìˆ˜
- **ëª…í™•í•œ ê²½ë¡œ**: ê¸°ëŠ¥ì„ ëª…í™•íˆ ë‚˜íƒ€ë‚´ëŠ” ê²½ë¡œ ì‚¬ìš©
- **HTTP ë©”ì„œë“œ**: ì ì ˆí•œ HTTP ë©”ì„œë“œ ì‚¬ìš© (GET, POST, PUT, DELETE)

### ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬

- **JSON íŒŒì‹±**: `await request.json()`ìœ¼ë¡œ ìš”ì²­ ë°ì´í„° íŒŒì‹±
- **ê²€ì¦**: í•„ìˆ˜ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
- **í‘œì¤€ ì‘ë‹µ**: ì¼ê´€ëœ ì‘ë‹µ í˜•ì‹ ì‚¬ìš©

### Session ê´€ë¦¬

- **Context Manager**: `async with SessionLocal() as session:` íŒ¨í„´ ì‚¬ìš©
- **íŠ¸ëœì­ì…˜**: Service ê³„ì¸µì—ì„œ íŠ¸ëœì­ì…˜ ê´€ë¦¬
- **ë¦¬ì†ŒìŠ¤ ì •ë¦¬**: ìë™ìœ¼ë¡œ session ì •ë¦¬

### Router ëª…ëª… ê·œì¹™

- **ê¸°ëŠ¥ ê¸°ë°˜**: `telegram_router.py`, `qa_router.py`
- **ëª…í™•í•œ ê²½ë¡œ**: `/telegram/webhook`, `/qa/ask`
- **HTTP ë©”ì„œë“œ**: `@router.post()`, `@router.get()`