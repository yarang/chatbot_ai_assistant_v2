---
globs: services/*.py
description: Service ê³„ì¸µ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°€ì´ë“œ
---

# ğŸ¤– Service ê³„ì¸µ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°€ì´ë“œ

## Service ê³„ì¸µ ì›ì¹™

- **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**: Service ê³„ì¸µì— ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‘ì„±
- **Repository ì¡°í•©**: ì—¬ëŸ¬ Repositoryë¥¼ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- **ì™¸ë¶€ API**: Gemini, Telegram ë“± ì™¸ë¶€ API í˜¸ì¶œ ë‹´ë‹¹
- **íŠ¸ëœì­ì…˜ ê´€ë¦¬**: Serviceì—ì„œ íŠ¸ëœì­ì…˜ ê²½ê³„ ê´€ë¦¬

## Gemini Service ì˜ˆì‹œ (`services/gemini_service.py`)

```python
from google import genai
import json

config = json.load(open("config.json"))

class GeminiService:
    def __init__(self):
        self.client = genai.Client(api_key=config["gemini"]["api_key"])
        self.model = config["gemini"]["model"]

    async def ask(self, prompt: str):
        response = self.client.models.generate_content(
            model=self.model,
            contents=prompt
        )
        usage = response.usage_metadata
        return {
            "text": response.text,
            "input_tokens": usage.prompt_token_count,
            "output_tokens": usage.candidates_token_count
        }
```

## Conversation Service ì˜ˆì‹œ

```python
from repository.conversation_repository import ConversationRepository
from services.gemini_service import GeminiService

class ConversationService:
    def __init__(self, conversation_repo: ConversationRepository, gemini: GeminiService):
        self.conversation_repo = conversation_repo
        self.gemini = gemini

    async def handle_question(self, session, user_uuid: str, question: str):
        # Gemini API í˜¸ì¶œ
        response = await self.gemini.ask(question)
        
        # ëŒ€í™” ê¸°ë¡ ì €ì¥
        conversation = await self.conversation_repo.create(
            session=session,
            user_uuid=user_uuid,
            question=question,
            answer=response["text"],
            in_tokens=response["input_tokens"],
            out_tokens=response["output_tokens"]
        )
        
        return conversation
```

## Service ê³„ì¸µ ì„¤ê³„ ì›ì¹™

### ì˜ì¡´ì„± ì£¼ì…

- **Constructor Injection**: Repositoryì™€ ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±ìì—ì„œ ì£¼ì…
- **Interface ë¶„ë¦¬**: ê°€ëŠ¥í•œ ê²½ìš° ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ ì„¤ê³„
- **ë‹¨ì¼ ì±…ì„**: ê° ServiceëŠ” í•˜ë‚˜ì˜ ë„ë©”ì¸ë§Œ ë‹´ë‹¹

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬

- **Repository ì¡°í•©**: ì—¬ëŸ¬ Repositoryë¥¼ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ë¡œì§ ì²˜ë¦¬
- **ì™¸ë¶€ API ë˜í•‘**: ì™¸ë¶€ API í˜¸ì¶œì„ Serviceì—ì„œ ë˜í•‘
- **íŠ¸ëœì­ì…˜ ê´€ë¦¬**: Serviceì—ì„œ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

### ì—ëŸ¬ ì²˜ë¦¬

- **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸**: Serviceì—ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ìœ„ë°˜ ì‹œ AppException ë°œìƒ
- **ì™¸ë¶€ API ì—ëŸ¬**: ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì ì ˆí•œ ì˜ˆì™¸ ì²˜ë¦¬
- **ë¡œê¹…**: ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰ ì‹œ ë¡œê¹…

### Service ë©”ì„œë“œ ëª…ëª… ê·œì¹™

- `handle_*()`: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œì„¸ìŠ¤ ì²˜ë¦¬
- `process_*()`: ë°ì´í„° ì²˜ë¦¬ ë° ë³€í™˜
- `validate_*()`: ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
- `send_*()`: ì™¸ë¶€ ì‹œìŠ¤í…œìœ¼ë¡œ ë°ì´í„° ì „ì†¡