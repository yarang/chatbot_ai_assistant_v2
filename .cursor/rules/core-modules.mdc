---
globs: core/*.py
description: ì½”ì–´ ëª¨ë“ˆ (database, logger, middleware, exceptions) ê°€ì´ë“œ
---

# ğŸ§© ì½”ì–´ ëª¨ë“ˆ ê°€ì´ë“œ

## Database ì„¤ì • (`core/database.py`)

```python
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import DeclarativeBase
import json

config = json.load(open("config.json"))
DATABASE_URL = config["database"]["url"]

engine = create_async_engine(DATABASE_URL, echo=False)
SessionLocal = async_sessionmaker(engine, expire_on_commit=False, class_=AsyncSession)

class Base(DeclarativeBase):
    pass
```

## Logger ì„¤ì • (`core/logger.py`)

```python
import logging
from logging.handlers import RotatingFileHandler
import os

LOG_DIR = "logs"
os.makedirs(LOG_DIR, exist_ok=True)

logger = logging.getLogger("app_logger")
logger.setLevel(logging.INFO)

file_handler = RotatingFileHandler(f"{LOG_DIR}/app.log", maxBytes=2*1024*1024, backupCount=3)
formatter = logging.Formatter("[%(asctime)s] [%(levelname)s] %(message)s")
file_handler.setFormatter(formatter)

logger.addHandler(file_handler)
```

## Middleware (`core/middleware.py`)

```python
from fastapi import Request
from starlette.middleware.base import BaseHTTPMiddleware
from core.logger import logger
import time

class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        start_time = time.time()
        try:
            response = await call_next(request)
            process_time = time.time() - start_time
            logger.info(
                f"{request.method} {request.url.path} "
                f"status={response.status_code} time={process_time:.2f}s"
            )
            return response
        except Exception as e:
            logger.error(f"Unhandled error: {e}")
            raise
```

## Exception Handling (`core/exceptions.py`)

```python
from fastapi import Request
from fastapi.responses import JSONResponse
from core.logger import logger

class AppException(Exception):
    def __init__(self, message: str, status_code: int = 400):
        self.message = message
        self.status_code = status_code

async def app_exception_handler(request: Request, exc: AppException):
    logger.warning(f"AppException: {exc.message}")
    return JSONResponse(
        status_code=exc.status_code,
        content={"error": exc.message}
    )

async def generic_exception_handler(request: Request, exc: Exception):
    logger.error(f"Unhandled Exception: {exc}")
    return JSONResponse(
        status_code=500,
        content={"error": "Internal Server Error"}
    )
```

## ì½”ì–´ ëª¨ë“ˆ ì›ì¹™

- **Database**: SQLAlchemy 2.0 async íŒ¨í„´ ì‚¬ìš©
- **Logger**: RotatingFileHandlerë¡œ ë¡œê·¸ íŒŒì¼ ê´€ë¦¬
- **Middleware**: ëª¨ë“  ìš”ì²­/ì‘ë‹µ ë¡œê¹…
- **Exceptions**: í‘œì¤€í™”ëœ ì—ëŸ¬ ì‘ë‹µ êµ¬ì¡°